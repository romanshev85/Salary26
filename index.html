<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–ó–∞—Ä–ø–ª–∞—Ç–∞ 2026</title>

  <!-- --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô –î–õ–Ø PWA --- -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="theme-color" content="#007aff">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô --- -->

  <style>
    /* –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: padding —Ç–µ–ø–µ—Ä—å –≤—Ö–æ–¥–∏—Ç –≤ —à–∏—Ä–∏–Ω—É */
    * { box-sizing: border-box; }

    :root {
      --primary: #007aff;
      --success: #28a745;
      --danger: #ff3b30;
      --warning: #ff9500;
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --text: #333;
      --text-sec: #666;
      /* –¶–≤–µ—Ç–∞ –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã */
      --btn-sec-bg: #e5e5ea;
      --btn-sec-text: #333;
      --input-bg: #fff;
    }

    /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
    body.dark-theme {
      --bg: #000000;
      --card-bg: #1c1c1e;
      --text: #ffffff;
      --text-sec: #98989d;
      --primary: #0a84ff;
      --success: #32d74b;
      --btn-sec-bg: #3a3a3c;
      --btn-sec-text: #ffffff;
      --input-bg: #2c2c2e;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
      transition: background 0.3s, color 0.3s;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 90px; 
    }
    h1, h2 { margin: 0; text-align: center; }
    /* –û–±–µ—Ä—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
    .header-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 24px 0 20px 0;
      position: relative;
    }
    h1 { font-size: 28px; margin: 0; }
    h2 { font-size: 22px; margin: 16px 0; }
    h3 { margin: 0 0 10px 0; font-size: 18px; }

    /* –ö–Ω–æ–ø–∫–∏ */
    button { cursor: pointer; border: none; outline: none; font-family: inherit; }
    
    /* –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
    .edit-title-btn {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      color: var(--text-sec);
      background: none;
      padding: 8px;
    }

    /* –°–µ—Ç–∫–∞ –¥–ª—è –º–µ—Å—è—Ü–µ–≤ (3 –≤ —Ä—è–¥) */
    .months-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .month-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--card-bg);
      border-radius: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      color: var(--primary);
      transition: transform 0.1s, box-shadow 0.1s, background 0.3s, color 0.3s;
      padding: 15px 5px;
      height: 100%;
      min-height: 70px;
    }
    .month-btn:active { transform: scale(0.97); box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
    .month-name { font-size: 15px; font-weight: 600; text-align: center; margin-bottom: 4px; }
    .month-badge { font-size: 12px; color: var(--text-sec); text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
    
    .back-btn {
      background: var(--btn-sec-bg);
      color: var(--btn-sec-text);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 10px;
    }
    
    /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –º–µ—Å—è—Ü–∞ (–ù–∞–∑–∞–¥, –°—Ç–∞–≤–∫–∞) */
    .month-header-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .current-rate-btn {
      font-size: 13px;
      color: var(--warning);
      background: rgba(255, 149, 0, 0.1);
      padding: 6px 10px;
      border-radius: 8px;
      font-weight: 600;
    }

    /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–¢–µ–º–∞, –ë—ç–∫–∞–ø) */
    .top-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .backup-btn, .theme-btn {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      background: var(--card-bg);
      color: var(--text-sec);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .backup-btn:active, .theme-btn:active { background: var(--btn-sec-bg); }
    .theme-btn { flex: 0 0 44px; }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
    .item {
      background: var(--card-bg);
      padding: 10px;
      border-radius: 12px;
      margin: 5px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      transition: background 0.3s;
    }
    .dayoff-item { border-left: 4px solid var(--success); }
    .trip-item { border-left: 4px solid var(--primary); }

    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
    }
    .item-title { font-weight: 600; font-size: 13px; display: flex; align-items: center; flex-wrap: wrap; }
    .item-cost { font-weight: 700; font-size: 13px; text-align: right; }
    .item-sub { font-size: 11px; color: var(--text-sec); margin-top: 3px; }

    /* –ë–µ–π–¥–∂ "–í—ã—Ö–æ–¥–Ω–æ–π" –≤ —Å–ø–∏—Å–∫–µ */
    .weekend-badge {
      display: inline-flex;
      align-items: center;
      background: #fff4e5;
      color: var(--warning);
      border:1px solid var(--warning);
      padding: 1px 6px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: 700;
      margin-left: 6px;
      text-transform: uppercase;
    }
    body.dark-theme .weekend-badge {
      background: #3d2f18;
      border-color: #6e4e1f;
    }

    .item-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px solid rgba(150,150,150,0.2);
    }
    .action-btn {
      padding: 5px 10px;
      font-size: 11px;
      border-radius: 6px;
      background: var(--btn-sec-bg);
      color: var(--btn-sec-text);
      flex: 1;
    }
    .action-btn.delete { background: #ffe5e5; color: var(--danger); }
    body.dark-theme .action-btn.delete { background: #5e1e1e; }

    /* –ò—Ç–æ–≥–æ */
    .total-block {
      background: var(--card-bg);
      padding: 16px;
      border-radius: 12px;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: background 0.3s;
    }
    .total-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 15px; }
    .total-row.final { 
      margin-top: 12px; 
      padding-top: 12px; 
      border-top:1px solid rgba(150,150,150,0.2); 
      font-weight: 800; 
      font-size: 18px; 
      color: var(--primary); 
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    body.dark-theme .modal { background: rgba(0,0,0,0.7); }
    
    .modal.visible { opacity: 1; pointer-events: auto; }
    
    .modal-content {
      background: var(--card-bg);
      width: 100%;
      max-width: 360px;
      border-radius: 20px 20px 0 0;
      padding: 16px;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      color: var(--text);
    }
    @media (min-width: 600px) {
      .modal { align-items: center; }
      .modal-content { border-radius: 20px; transform: translateY(20px); opacity: 0; }
      .modal.visible .modal-content { transform: translateY(0); opacity: 1; }
    }
    .modal.visible .modal-content { transform: translateY(0); }

    .input-group { margin-bottom: 10px; }
    .input-label { display: block; font-size: 13px; color: var(--text-sec); margin-bottom: 4px; font-weight: 500; }
    .modal-content input {
      width: 100%;
      padding: 10px;
      border:1px solid #ddd;
      border-radius: 10px;
      font-size: 15px;
      background: var(--input-bg);
      color: var(--text);
    }
    body.dark-theme .modal-content input {
      border-color: #48484a;
    }
    .modal-content input:focus { border-color: var(--primary); }

    /* –ö–Ω–æ–ø–∫–∞-–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –¥–ª—è –í—ã—Ö–æ–¥–Ω–æ–≥–æ */
    .toggle-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 12px;
      font-weight: 600;
      color: #888;
      background: white;
      transition: all 0.2s;
      cursor: pointer;
      margin-bottom: 12px;
      font-size: 15px;
      flex-wrap: wrap;
    }
    body.dark-theme .toggle-btn {
      background: #2c2c2e;
      color: #98989d;
      border-color: #48484a;
    }
    .toggle-btn:active { transform: scale(0.98); }
    .toggle-btn.active {
      border-color: var(--warning);
      background: #fff4e5;
      color: var(--warning);
    }
    body.dark-theme .toggle-btn.active {
      background: #3d2f18;
    }
    .toggle-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid #ccc;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    body.dark-theme .toggle-icon {
      border-color: #48484a;
      background: #2c2c2e;
    }
    .toggle-btn.active .toggle-icon {
      border-color: var(--warning);
      background: var(--warning);
      color: white;
    }

    .btn-row { display: flex; gap: 10px; margin-top: 20px; }
    .btn-row button { flex: 1; padding: 12px; border-radius: 12px; font-weight: 600; font-size: 16px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: var(--btn-sec-bg); color: var(--btn-sec-text); }
    .btn-danger { background: var(--danger); color: white; }
    
    .fab-container {
      position: fixed; bottom: 20px; left: 0; right: 0; padding: 0 16px;
      max-width: 600px; margin: 0 auto; box-sizing: border-box; pointer-events: none;
    }
    .fab-row { display: flex; gap: 10px; pointer-events: auto; }
    .fab-btn {
      flex: 1; padding: 16px; border-radius: 16px; color: white; font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; gap: 8px;
    }
  </style>
</head>
<body>

  <div class="container" id="app"></div>
  
  <div id="fab-container" class="fab-container" style="display:none;">
    <div class="fab-row">
      <button class="fab-btn" style="background: var(--primary);" onclick="openForm('trip')">‚ûï –ü–æ–µ–∑–¥–∫–∞</button>
      <button class="fab-btn" style="background: var(--success);" onclick="openForm('dayoff')">‚ûï –í—ã—Ö–æ–¥–Ω–æ–π</button>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content" id="modal-content"></div>
  </div>

  <!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ -->
  <input type="file" id="fileInput" style="display: none;" accept=".json" onchange="handleFileImport(this)">

  <script>
    // --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
    const months = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
    let data = JSON.parse(localStorage.getItem('salary2026')) || {};
    let currentMonth = '';
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    let appTitle = localStorage.getItem('app_title') || '–ó–∞—Ä–ø–ª–∞—Ç–∞ 2026';
    document.title = appTitle; // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∫–ª–∞–¥–∫—É –±—Ä–∞—É–∑–µ—Ä–∞

    const DEFAULT_RATE = 3870;
    const formatMoney = (num) => new Intl.NumberFormat('ru-RU').format(num) + ' ‚ÇΩ';

    function save() {
      localStorage.setItem('salary2026', JSON.stringify(data));
    }

    // --- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–ì–û–õ–û–í–ö–ê ---
    function openTitleModal() {
      const html = `
        <h3>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3>
        <div class="input-group">
          <input type="text" id="title_input" value="${appTitle}">
        </div>
        <div class="btn-row">
          <button class="btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn-primary" onclick="saveAppTitle()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      `;
      modalContent.innerHTML = html;
      modal.classList.add('visible');
      setTimeout(() => document.getElementById('title_input').focus(), 100);
    }

    function saveAppTitle() {
      const val = document.getElementById('title_input').value.trim();
      if (val) {
        appTitle = val;
        localStorage.setItem('app_title', val);
        document.title = val; // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∫–ª–∞–¥–∫—É –±—Ä–∞—É–∑–µ—Ä–∞
        closeModal();
        renderMonthList();
      }
    }

    // --- –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –ú–ï–°–Ø–¶–ê –° –ú–ò–ì–†–ê–¶–ò–ï–ô ---
    function getMonthData(monthName) {
      let monthObj = data[monthName];
      
      // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤–æ–æ–±—â–µ
      if (!monthObj) {
        monthObj = { rate: DEFAULT_RATE, items: [] };
        data[monthName] = monthObj;
      }
      // –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (–ø—Ä–æ—Å—Ç–æ –º–∞—Å—Å–∏–≤ –∑–∞–ø–∏—Å–µ–π), –º–∏–≥—Ä–∏—Ä—É–µ–º
      else if (Array.isArray(monthObj)) {
        const oldItems = monthObj;
        monthObj = { rate: DEFAULT_RATE, items: oldItems };
        data[monthName] = monthObj;
        save(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      }
      
      return monthObj;
    }

    // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –°–¢–ê–í–ö–ò –î–õ–Ø –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –ú–ï–°–Ø–¶–ê ---
    function openRateModal() {
      const monthData = getMonthData(currentMonth);
      const currentRate = monthData.rate;

      const html = `
        <h3>–°—Ç–∞–≤–∫–∞: ${currentMonth}</h3>
        <div class="input-group">
          <label class="input-label">–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞ (—Ä—É–±)</label>
          <input type="number" id="rate_input" value="${currentRate}">
        </div>
        <div class="btn-row">
          <button class="btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn-primary" onclick="saveMonthRate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      `;
      modalContent.innerHTML = html;
      modal.classList.add('visible');
      setTimeout(() => document.getElementById('rate_input').focus(), 100);
    }

    function saveMonthRate() {
      const val = document.getElementById('rate_input').value;
      if (val && !isNaN(val)) {
        const monthData = getMonthData(currentMonth);
        monthData.rate = parseInt(val);
        save();
        closeModal();
        showMonth(currentMonth); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å –Ω–æ–≤–æ–π —Å—Ç–∞–≤–∫–æ–π
      }
    }

    // --- –¢–ï–ú–ê ---
    function toggleTheme() {
      const body = document.body;
      body.classList.toggle('dark-theme');
      const isDark = body.classList.contains('dark-theme');
      localStorage.setItem('dark_theme', isDark);
      renderMonthList();
    }

    function applyTheme() {
      const isDark = localStorage.getItem('dark_theme') === 'true';
      if (isDark) {
        document.body.classList.add('dark-theme');
      }
    }

    function getFirstDay(dayStr) {
      if (!dayStr) return 999;
      const num = parseInt(dayStr.replace(/[^0-9].*$/, ''));
      return isNaN(num) ? 999 : num;
    }

    function isRange(dayStr) {
      return dayStr && (dayStr.includes('-') || dayStr.includes('‚Äì'));
    }

    function suggestNights(dayStr) {
      if (!isRange(dayStr)) return 0;
      const clean = dayStr.replace('‚Äì', '-');
      const parts = clean.split('-').map(p => p.trim());
      if (parts.length === 2) {
        const start = parseInt(parts[0]);
        const end = parseInt(parts[1]);
        if (!isNaN(start) && !isNaN(end)) {
          return end >= start ? end - start : 2;
        }
      }
      return 1;
    }

    function calculateDaysInDayoff(dayStr) {
      if (!dayStr) return 1;
      if (!isRange(dayStr)) return 1; 
      const clean = dayStr.replace('‚Äì', '-');
      const parts = clean.split('-').map(p => p.trim());
      if (parts.length === 2) {
        const start = parseInt(parts[0]);
        const end = parseInt(parts[1]);
        if (!isNaN(start) && !isNaN(end)) {
          return Math.max(0, end - start + 1);
        }
      }
      return 1;
    }

    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: calcTrip –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Ç–∞–≤–∫—É –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç
    function calcTrip(trip, rate) {
      const effectiveKM = trip.km ? (trip.km < 250 ? 250 : trip.km) : 0;
      const coeff =1 + (trip.isWeekend ?1 : 0) + effectiveKM / 250 + trip.stores / 10;
      return {
        cost: Math.round(coeff * rate),
        perDiem: trip.nights * 1400
      };
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –†–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (Backup) ---

    function exportData() {
      const dataStr = JSON.stringify(data, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const dateStr = new Date().toISOString().slice(0,10);
      a.download = `salary_backup_${dateStr}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert("–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É '–§–∞–π–ª—ã' (–∏–ª–∏ '–ó–∞–≥—Ä—É–∑–∫–∏') –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ.");
    }

    function triggerImport() {
      document.getElementById('fileInput').click();
    }

    function handleFileImport(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          if (typeof importedData === 'object' && importedData !== null) {
            const confirmMsg = "–≠—Ç–æ —É–¥–∞–ª–∏—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏ –∑–∞–º–µ–Ω–∏—Ç –∏—Ö –Ω–∞ —Ñ–∞–π–ª–æ–º. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?";
            if (confirm(confirmMsg)) {
              data = importedData;
              save();
              renderMonthList();
              alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!");
            }
          } else {
            alert("–û—à–∏–±–∫–∞: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.");
          }
        } catch (err) {
          alert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: " + err.message);
        }
        input.value = '';
      };
      reader.readAsText(file);
    }

    // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ ---

    function renderMonthList() {
      currentMonth = '';
      document.getElementById('fab-container').style.display = 'none';
      
      const isDark = document.body.classList.contains('dark-theme');
      const themeIcon = isDark ? '‚òÄÔ∏è' : 'üåô';
      
      let html = `
        <div class="header-wrapper">
          <h1>${appTitle}</h1>
          <button class="edit-title-btn" onclick="openTitleModal()">‚úèÔ∏è</button>
        </div>
      `;

      html += `
        <div class="top-controls">
          <button class="theme-btn" onclick="toggleTheme()" title="–¢–µ–º–∞">${themeIcon}</button>
          <button class="backup-btn" onclick="exportData()">üíæ</button>
          <button class="backup-btn" onclick="triggerImport()">üìÇ</button>
        </div>
      `;

      html += `<div class="months-grid">`;

      months.forEach(month => {
        const monthData = getMonthData(month);
        const trips = monthData.items.filter(t => t.type === 'trip');
        // –ò–°–ü–û–õ–¨–ó–£–ï–ú –°–¢–ê–í–ö–£ –≠–¢–û–ì–û –ú–ï–°–Ø–¶–ê
        const rate = monthData.rate;
        
        let total = 0;
        trips.forEach(t => {
           const r = calcTrip(t, rate);
           total += r.cost;
        });
        const badge = total > 0 ? `<div class="month-badge">${formatMoney(total)}</div>` : '';
        
        html += `
          <button class="month-btn" onclick="showMonth('${month}')">
            <div class="month-name">${month}</div>
            ${badge}
          </button>`;
      });

      html += `</div>`;
      
      document.getElementById('app').innerHTML = html;
    }

    function showMonth(month) {
      currentMonth = month;
      const monthData = getMonthData(month);
      const items = monthData.items;
      const currentRate = monthData.rate;
      const sortedItems = [...items].sort((a, b) => getFirstDay(a.dayRange) - getFirstDay(b.dayRange));
      
      let contentHtml = '';

      if (sortedItems.length === 0) {
        contentHtml = `<div style="text-align:center;color:#999;padding:40px 0;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –Ω–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</div>`;
      } else {
        sortedItems.forEach(item => {
          if (item.type === 'dayoff') {
            const daysCount = calculateDaysInDayoff(item.dayRange);
            const daysText = daysCount > 1 ? ` (${daysCount} –¥–Ω.)` : '';
            
            contentHtml += `
              <div class="item dayoff-item">
                <div class="item-header">
                  <div class="item-title">${item.dayRange}${daysText}</div>
                  <div class="item-cost" style="color:var(--success)">–í—ã—Ö–æ–¥–Ω–æ–π</div>
                </div>
                <div class="item-actions">
                  <button class="action-btn" onclick="openForm('dayoff', '${item.id}')">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                  <button class="action-btn delete" onclick="confirmDelete('${item.id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </div>
              </div>`;
          } else {
            // –ò–°–ü–û–õ–¨–ó–£–ï–ú –°–¢–ê–í–ö–£ –≠–¢–û–ì–û –ú–ï–°–Ø–¶–ê
            const r = calcTrip(item, currentRate);
            const weekendBadge = item.isWeekend ? `<span class="weekend-badge">‚úî –í—ã—Ö–æ–¥–Ω–æ–π</span>` : '';
            
            contentHtml += `
              <div class="item trip-item">
                <div class="item-header">
                  <div class="item-title">
                    ${item.dayRange} ‚Äî ${item.location}
                    ${weekendBadge}
                  </div>
                  <div class="item-cost">${formatMoney(r.cost)}</div>
                </div>
                <div class="item-sub">
                   –ö–ú: ${item.km || 0} | –¢–æ—á–∫–∏: ${item.stores} | –°—É—Ç–æ—á–Ω—ã–µ: ${formatMoney(r.perDiem)}
                </div>
                <div class="item-actions">
                  <button class="action-btn" onclick="openForm('trip', '${item.id}')">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                  <button class="action-btn delete" onclick="confirmDelete('${item.id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </div>
              </div>`;
          }
        });
      }

      let totalCost = 0, totalPerDiem = 0, totalDayoffs = 0;
      items.forEach(t => {
        if (t.type === 'trip') {
          const r = calcTrip(t, currentRate);
          totalCost += r.cost;
          totalPerDiem += r.perDiem;
        } else if (t.type === 'dayoff') {
          totalDayoffs += calculateDaysInDayoff(t.dayRange);
        }
      });

      const html = `
        <div class="month-header-controls">
          <button class="back-btn" onclick="renderMonthList()">‚Üê –ù–∞–∑–∞–¥</button>
          <button class="current-rate-btn" onclick="openRateModal()">‚öôÔ∏è –°—Ç–∞–≤–∫–∞: ${currentRate}</button>
        </div>
        <h2>${month}</h2>
        ${contentHtml}
        ${items.length > 0 ? `
        <div class="total-block">
          <div class="total-row"><span>–†–∞–±–æ—Ç–∞:</span> <span>${formatMoney(totalCost)}</span></div>
          <div class="total-row"><span>–°—É—Ç–æ—á–Ω—ã–µ:</span> <span>${formatMoney(totalPerDiem)}</span></div>
          <div class="total-row" style="color: var(--success); font-weight: 600;">
            <span>–í—ã—Ö–æ–¥–Ω—ã–µ (–¥–Ω–∏ –æ—Ç–¥—ã—Ö–∞):</span> <span>${totalDayoffs}</span>
          </div>
          <div class="total-row final"><span>–ò—Ç–æ–≥–æ:</span> <span>${formatMoney(totalCost)}</span></div>
        </div>` : ''}
      `;
      
      document.getElementById('app').innerHTML = html;
      document.getElementById('fab-container').style.display = 'block';
    }

    // --- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏ –§–æ—Ä–º—ã ---

    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modal-content');

    function closeModal() {
      modal.classList.remove('visible');
      setTimeout(() => { modalContent.innerHTML = ''; }, 300);
    }

    function handleEnterKey(e, callback) {
      if (e.key === 'Enter') {
        e.preventDefault(); 
        callback();
      }
    }

    function toggleWeekend() {
      const btn = document.getElementById('weekendBtn');
      const icon = document.getElementById('weekendIcon');
      const isActive = btn.classList.contains('active');
      
      if (isActive) {
        btn.classList.remove('active');
        icon.innerHTML = '';
      } else {
        btn.classList.add('active');
        icon.innerHTML = '‚úî';
      }
    }

    function openForm(type, itemId = null) {
      const monthData = getMonthData(currentMonth);
      const item = itemId ? monthData.items.find(t => t.id === itemId) : null;
      const isEdit = !!item;
      
      let html = '';
      
      if (type === 'trip') {
        const dayRange = item ? item.dayRange : '';
        const location = item ? item.location : '';
        const km = item && item.km !== null ? item.km : '';
        const stores = item ? item.stores : 0;
        const isWeekend = item ? item.isWeekend : false;
        const nights = item ? item.nights : (isEdit ? 0 : suggestNights(dayRange));

        html = `
          <h3>${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'} –ø–æ–µ–∑–¥–∫—É</h3>
          <div class="input-group">
            <label class="input-label">–î–∞—Ç—ã (–Ω–∞–ø—Ä. 5 –∏–ª–∏ 5-7)</label>
            <input type="text" id="f_dayRange" value="${dayRange}" placeholder="5-7">
          </div>
          <div class="input-group">
            <label class="input-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ / –ì–æ—Ä–æ–¥</label>
            <input type="text" id="f_location" value="${location}" placeholder="–ú–æ—Å–∫–≤–∞">
          </div>
          <div class="input-group">
            <label class="input-label">–ö–∏–ª–æ–º–µ—Ç—Ä—ã (–µ—Å–ª–∏ < 250, —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ 250)</label>
            <input type="number" id="f_km" value="${km}" placeholder="0">
          </div>
          <div class="input-group">
            <label class="input-label">–¢–æ—á–∫–∏ (–º–∞–≥–∞–∑–∏–Ω—ã)</label>
            <input type="number" id="f_stores" value="${stores}" placeholder="0">
          </div>
          
          <div class="toggle-btn ${isWeekend ? 'active' : ''}" id="weekendBtn" onclick="toggleWeekend()">
            <div class="toggle-icon" id="weekendIcon">${isWeekend ? '‚úî' : ''}</div>
            –í—ã—Ö–æ–¥–Ω–æ–π (x2)
          </div>
          <input type="hidden" id="f_isWeekend" value="${isWeekend}">

          <div class="input-group">
            <label class="input-label">–ù–æ—á–µ–≤–∫–∏ (x1400‚ÇΩ)</label>
            <input type="number" id="f_nights" value="${nights}" placeholder="0">
          </div>
          <div class="btn-row">
            <button class="btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn-primary" id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        `;
      } else {
        const dayRange = item ? item.dayRange : '';
        html = `
          <h3>${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'} –≤—ã—Ö–æ–¥–Ω–æ–π</h3>
          <div class="input-group">
            <label class="input-label">–î–∞—Ç–∞</label>
            <input type="text" id="f_dayRange" value="${dayRange}" placeholder="9-14">
          </div>
          <div class="btn-row">
            <button class="btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn-primary" id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        `;
      }

      modalContent.innerHTML = html;
      modal.classList.add('visible');
      setTimeout(() => document.getElementById('f_dayRange').focus(), 100);

      const saveCallback = () => saveForm(type, itemId);
      document.getElementById('btnSave').onclick = saveCallback;
      
      const inputs = modalContent.querySelectorAll('input:not([type=hidden])');
      inputs.forEach(input => {
        input.onkeyup = (e) => handleEnterKey(e, saveCallback);
      });
    }

    let deleteId = null;
    function confirmDelete(id) {
      deleteId = id;
      const html = `
        <h3 style="color:var(--danger)">–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?</h3>
        <p style="color:#666; margin-bottom:20px;">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
        <div class="btn-row">
          <button class="btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn-danger" onclick="executeDelete()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;
      modalContent.innerHTML = html;
      modal.classList.add('visible');
    }

    function executeDelete() {
      if (deleteId && currentMonth) {
        const monthData = getMonthData(currentMonth);
        monthData.items = monthData.items.filter(t => t.id !== deleteId);
        save();
        showMonth(currentMonth);
      }
      closeModal();
    }

    function saveForm(type, itemId) {
      const dayRange = document.getElementById('f_dayRange').value.trim();
      if (!dayRange) {
        alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É');
        return;
      }

      let newItem = {
        id: itemId || Date.now().toString(),
        type: type,
        dayRange: dayRange
      };

      if (type === 'trip') {
        newItem.location = document.getElementById('f_location').value || '‚Äî';
        const kmVal = document.getElementById('f_km').value;
        newItem.km = kmVal ? parseInt(kmVal) : null;
        newItem.stores = parseInt(document.getElementById('f_stores').value) || 0;
        newItem.isWeekend = document.getElementById('f_isWeekend').value === 'true';
        newItem.nights = parseInt(document.getElementById('f_nights').value) || 0;
      } else {
        newItem.note = '–í—ã—Ö–æ–¥–Ω–æ–π';
      }

      const monthData = getMonthData(currentMonth);
      
      if (itemId) {
        const index = monthData.items.findIndex(t => t.id === itemId);
        if (index !== -1) monthData.items[index] = newItem;
      } else {
        monthData.items.push(newItem);
      }

      save();
      closeModal();
      showMonth(currentMonth);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.addEventListener('load', applyTheme);
    renderMonthList();
    modal.onclick = (e) => { if (e.target === modal) closeModal(); };

    const originalToggle = toggleWeekend;
    toggleWeekend = function() {
      const btn = document.getElementById('weekendBtn');
      const hiddenInput = document.getElementById('f_isWeekend');
      originalToggle();
      hiddenInput.value = btn.classList.contains('active') ? 'true' : 'false';
    }

  </script>
</body>
</html>
